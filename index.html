<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Secure QR Decoder</title>
<style>
  body { font-family: system-ui, sans-serif; max-width: 500px; margin: 40px auto; padding: 10px; }
  h1 { font-size: 1.5rem; margin-bottom: 20px; text-align: center; }
  label { display: block; margin: 12px 0 6px; font-weight: bold; }
  textarea, input { width: 100%; padding: 10px; box-sizing: border-box; border-radius: 6px; border: 1px solid #ccc; font-size: 1rem; }
  button { margin-top: 15px; padding: 10px 16px; font-size: 1rem; border-radius: 6px; border: none; background: #007bff; color: white; cursor: pointer; width: 100%; }
  button:hover { background: #0056b3; }
  textarea[readonly] { background: #f5f5f5; }
</style>
</head>
<body>
<h1>Secure QR Decoder</h1>

<label>Paste encrypted payload (or scan QR)</label>
<textarea id="payload" rows="4" placeholder="Paste payload here"></textarea>

<label>Enter passcode</label>
<input type="password" id="password" placeholder="Passcode" />

<button id="decryptBtn">Decrypt Message</button>

<label>Decrypted message</label>
<textarea id="decrypted" rows="4" readonly placeholder="Decrypted text will appear here"></textarea>

<script>
function u8ToB64(u8){ return btoa(String.fromCharCode(...u8)); }
function b64ToU8(b64){ return Uint8Array.from(atob(b64), c=>c.charCodeAt(0)); }

async function deriveKey(password, salt, iterations=200000){
  const enc = new TextEncoder();
  const pwKey = await crypto.subtle.importKey('raw', enc.encode(password), 'PBKDF2', false, ['deriveKey']);
  return crypto.subtle.deriveKey({name:'PBKDF2',salt,iterations,hash:'SHA-256'}, pwKey, {name:'AES-GCM',length:256}, false, ['encrypt','decrypt']);
}

async function decryptPayload(password, payload){
  const parts = payload.trim().split(':');
  if(parts.length !== 3) throw new Error('Invalid payload format');
  const salt = b64ToU8(parts[0]);
  const iv = b64ToU8(parts[1]);
  const ct = b64ToU8(parts[2]);
  const key = await deriveKey(password, salt);
  const plainBuf = await crypto.subtle.decrypt({name:'AES-GCM',iv}, key, ct);
  return new TextDecoder().decode(plainBuf);
}

document.getElementById('decryptBtn').addEventListener('click', async ()=>{
  const payload = document.getElementById('payload').value.trim();
  const password = document.getElementById('password').value;
  if(!payload){ alert('Paste the payload first'); return; }
  try{
    const decrypted = await decryptPayload(password, payload);
    document.getElementById('decrypted').value = decrypted;
  } catch(e){
    alert('Decryption failed â€” wrong passcode or corrupted payload.');
  }
});
</script>
</body>
</html>
